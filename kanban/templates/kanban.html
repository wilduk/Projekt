<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kanban</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
</head>
<body>
{% verbatim %}
<template id="kanban-columns">
    <div class="swim-lane">
        <div class="heading">
            <div class="nazwa">
                <h4 v-if="!isEditing">{{ column.name }}</h4>
                <input v-if="isEditing" :value="editingName" />
            </div>
            <div :class="{ licznik: true, alert: Number.isInteger(column.max) && columnNotes.length > column.max }">
                {{ columnNotes.length }}
                <span v-if="Number.isInteger(column.max)">
                    / {{ column.max }}
                </span>
            </div>
        </div>
        <div class="przyciski">
            <button type="button" :disabled="idx === 0" class="move-left paddington" @click="$parent.moveColumn(column.id, idx, -1)">◀</button>
            <button v-if="!isEditing" type="submit" name="edit" class="edit" @click="edytujKolumne">Edytuj</button>
            <button v-if="!isEditing" type="button" name="delete" class="delete" @click="$parent.deleteColumn(column.id)">Usuń</button>
            <button v-if="isEditing" type="submit" name="submit" class="edit" @click="edytujKolumneAkcept">Akceptuj</button>
            <button v-if="isEditing" type="submit" name="cancel" class="delete" @click="cancelNoteChanges">Anuluj</button>
            <button type="button" :disabled="idx >= columns.length - 1" class="move-right paddington" @click="$parent.moveColumn(column.id, idx, 1)">▶</button>
        </div>
        <note-component
            :note-id="note.id"
            :update-note="$parent.updateNote"
            v-for="note in columnNotes"
        >
            {{ note.name }}
        </note-component>
        <form class="note-form">
            <input type="text" placeholder="Nowe zadanie..." />
            <button type="submit" style="float: right;">Dodaj</button>
        </form>
    </div>
</template>
<div class="board" id="app">
    <div class="lanes" id="lanes">
        <column-component
            :key="column.id"
            v-for="(column, idx) in columns"
            :data-id="column.id"
            :column="column"
            :idx="idx"
            :columns="columns"
            :notes="notes"
        >
        </column-component>
        <button type="submit" class="circle" id="add" onclick="dodajKolumne()"></button>
    </div>
{% endverbatim %}
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function request(url, method, body) {
        const csrftoken = getCookie('csrftoken');
        return fetch(url, {
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': csrftoken
            },
            method,
            body: body ? JSON.stringify(body) : undefined,
        }).then((response) => {
            if (method === 'DELETE') {
                return null;
            }
            return response.json();
        });
    }

    const { createApp, defineComponent, onMounted, ref } = Vue;

    const insertAboveTask = (zone, mouseY) => {
        const els = zone.querySelectorAll(".task:not(.is-dragging)");

        let closestTask = null;
        let closestOffset = Number.NEGATIVE_INFINITY;

        els.forEach((task) => {
            const {top} = task.getBoundingClientRect();

            const offset = mouseY - top;

            if (offset < 0 && offset > closestOffset) {
                closestOffset = offset;
                closestTask = task;
            }
        });

        return closestTask;
    };

    const NoteComponent = defineComponent({
        template: `
            <div class="task egzorcysta" draggable="true">
                <slot></slot>
                <div class="przyciski">
                    <button class="edytowanie">Edytuj</button>
                    <button class="usuwanie">Usuń</button>
                </div>
            </div>
        `,
        props: ['noteId', 'updateNote'],
        mounted() {
            const dragstart = () => {
                this.$el.classList.add("is-dragging");
            };
            const dragend = (e) => {
                const task = this.$el;
                task.classList.remove("is-dragging");
                const column = task.closest(".swim-lane");
                const columnId = column.dataset.id;
                var pos = null;
                var i = 1;

                for (const element of column.querySelectorAll('.task')) {
                    if (element == task) {
                        pos = i;
                        break;
                    }
                    i += 1;
                }
                this.updateNote({
                    id: parseInt(this.noteId),
                    column: parseInt(columnId),
                    position: pos,
                });
            };
            this.$el.addEventListener('dragstart', () => dragstart());
            this.$el.addEventListener('dragend', (e) => dragend(e));
        },
    });

    const ColumnComponent = defineComponent({
        template: '#kanban-columns',
        props: ['column', 'idx', 'columns', 'notes'],
        components: {
            NoteComponent,
        },
        data() {
            return {
                columnNotes: [],
                isEditing: false,
                editingName: '',
            };
        },
        watch: {
            notes: {
                handler: 'filterNotes',
                immediate: true
            },
            columns: {
                handler: 'filterNotes',
                immediate: true
            },
        },
        methods: {
            filterNotes() {
                this.columnNotes = this.notes.filter((note) => note.column === this.column.id)
            },
            edytujKolumne() {
                this.isEditing = true;
                this.editingName = this.column.name;
            },
            edytujKolumneAkcept() {
                this.isEditing = false;
                this.editingName = this.$el.querySelector('input').value;
                this.$parent.editColumn(this.column.id, this.editingName);
            },
            cancelNoteChanges() {
                this.isEditing = false;
            }
        },
        mounted() {
            this.$el.addEventListener('dragover', (e) => {
                const column = this.$el;
                e.preventDefault();

                const bottomTask = insertAboveTask(column, e.clientY);
                const curTask = document.querySelector(".is-dragging");

                if (!bottomTask) {
                    const form = this.$el.querySelector('form');
                    column.insertBefore(curTask, form);
                } else {
                    column.insertBefore(curTask, bottomTask);
                }
            });
        }
    });

    createApp({
        components: {
            ColumnComponent,
        },
        setup() {
            const columns = ref([]);
            const notes = ref([]);

            const fetchNotes = () => request('/api/notes/', 'GET').then((res) => {
                res.sort((a, b) => {
                    return a.position - b.position;
                });
                // console.log({ res, columns: columns.value });
                // columns.value = [...columns.value];
                notes.value = [];
                setTimeout(() => {
                    notes.value = res;
                });
                // console.log( { Vue });
            });
            const updateNote = (data) => {
                return request('/api/notes/', 'PUT', data)
                   .then(() => fetchNotes());
            };
            fetchNotes();

            const fetchColumns = () => request('/api/columns/', 'GET').then((res) => {
                columns.value = res;
            });
            fetchColumns();

            function moveColumn (columnId, idx, przesuniecie) {
                const position = idx + 1;
                const newPosition = position + przesuniecie;
                if (newPosition >= 1 && newPosition <= columns.value.length) {
                    return request('/api/columns/', 'PUT', {
                        id: parseInt(columnId),
                        position: newPosition,
                    }).then(() => {
                        return fetchColumns();
                    });
                }
            }

            function editColumn (columnId, columnName, columnMax) {
                return request('/api/columns/', 'PUT', {
                    id: parseInt(columnId),
                    name: columnName,
                    max: columnMax,
                }).then(() => {
                    return fetchColumns();
                });
            }

            function deleteColumn (columnId) {
                return request('/api/columns/', 'DELETE', {
                    id: parseInt(columnId),
                }).then(() => {
                    return fetchColumns();
                });
            }

            return {
                columns,
                notes,
                moveColumn,
                editColumn,
                deleteColumn,
                updateNote,
            }
        },
    }).mount('#app')
</script>
</body>
</html>