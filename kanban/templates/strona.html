<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kanban</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
</head>
<body>
<div class="board">
    <div class="lanes" id="lanes">
        {% for column in columns %}
            <div class="swim-lane" id="{{ column.id }}-lane" data-colid="{{ column.id }}">
                <div class="heading">
                    <div class="nazwa">
                        <h4>{{ column.name }}</h4>
                    </div>
                    <div class="licznik" data-max="{{ column.max }}">liczenie</div>
                </div>
                <div class="przyciski">
                    <button type="button" class="move-left" onclick="moveColumnLeft('{{ column.id }}-lane')"><</button>
                    <button type="button" class="move-right" onclick="moveColumnRight('{{ column.id }}-lane')">></button>
                    <button type="submit" name="edit" class="edit" onclick="edytujKolumne('{{ column.id }}')">Edytuj</button>
                    <button type="button" name="delete" class="delete" onclick="usunKolumne('{{ column.id }}')">UsuÅ„</button>
                </div>
                <!-- Existing tasks -->
                {% for note in notes %}
                    {% if note.column == column.id %}
                        <div class="task" draggable="true" id="{{ note.id }}-note" data-noteid="{{ note.id }}">{{ note.name }}
                            <button class="usuwanie" onclick="usunTaska('{{ note.id }}-note')">ðŸ—‘</button>
                            <button class="edytowanie" onclick="edytujTaska('{{ note.id }}-note')">E</button>
                        </div>
                    {% endif %}
                {% endfor %}
                <form id="{{ column.id }}-form" class="note-form">
                    <input type="text" placeholder="Nowe zadanie..." id="{{ column.id }}-input"/>
                    <button type="submit">Dodaj</button>
                </form>
            </div>
        {% endfor %}
        <button type="submit" class="circle" id="add" onclick="dodajKolumne()"></button>
        <!-- Other swim-lanes -->
    </div>
</div>

<script>
    // JavaScript functions for moving columns
    function moveColumnLeft(columnId) {
        const column = document.getElementById(columnId);
        const prevColumn = column.previousElementSibling;
        if (prevColumn) {
            column.parentNode.insertBefore(column, prevColumn);
        }
   const csrftoken = getCookie('csrftoken');
        fetch('/api/columns/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: json
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            column.textContent = data.name;
            giveDefaultButtons(column);
        })
        .catch(error => console.error(error));
    }

    function moveColumnRight(columnId) {
        const column = document.getElementById(columnId);
        const nextColumn = column.nextElementSibling;
        if (nextColumn) {
            column.parentNode.insertBefore(nextColumn, column);
        }

        const csrftoken = getCookie('csrftoken');
        fetch('/api/columns/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: json
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            column.textContent = data.name;
            giveDefaultButtons(column);
        })
        .catch(error => console.error(error));
    }

    const form = document.getElementById("todo-form");

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const formElement = e.target;
        const input = formElement.querySelector('input');
        const value = input.value;
        const todoLane = formElement.parentElement;

        if (!value) return;

        try {
            // Send POST request to create a new task
            const csrftoken = getCookie('csrftoken');
            const response = await fetch("/api/notes/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    id: parseInt(todoLane.dataset.colid), // Assuming 'todo-lane' is the ID of the column
                    name: value
                })
            });

            if (!response.ok) {
                throw new Error("Failed to add task");
            }

            // Assuming the response returns the added task data
            const taskData = await response.json();

            // Create new task element
            const newTask = document.createElement("div");
            newTask.classList.add("task");
            newTask.setAttribute("draggable", "true");
            newTask.innerText = taskData.name;
            newTask.dataset.noteid = taskData.id;

            {#<p class="task" draggable="true" data-noteid="{{ note.id }}">{{ note.name }}</p>#}

            newTask.addEventListener("dragstart", () => {
                dragstart(newTask);
            });

            newTask.addEventListener("dragend", () => {
                dragend(newTask);
            });

            // Append the new task to the todo lane
            const form = document.getElementById(todoLane.id.slice(0, -5) + "-form");
            todoLane.insertBefore(newTask, form);

            // Clear input field
            input.value = "";
        } catch (error) {
            console.error("Error:", error.message);
        }
    }

    const draggables = document.querySelectorAll(".task");
    const droppables = document.querySelectorAll(".swim-lane");

    let stary;
    let starapoz;

    function dragstart(task){
        stary = task.parentElement;
        starapoz = 0;
        for (let child of stary.children) {
            if(child == task){
                break;
            }
            else{
                starapoz += 1;
            }
        }
        task.classList.add("is-dragging");
    }

    async function dragend(task) {
        task.classList.remove("is-dragging");
        task.dataset.zoneid = task.closest(".swim-lane").getAttribute("id");
        const zoneId = task.dataset.zoneid; // Pobierz identyfikator strefy
        const zone = document.getElementById(zoneId);
        var pos = null;


        var i = -1;
        for (const element of zone.children) {
            if (element == task) {
                pos = i;
            }
            i += 1;
        }

        zlicz(stary);
        zlicz(zone);
        const licznik = zone.getElementsByClassName("heading")[0].getElementsByClassName("licznik")[0]
        if (licznik.dataset.max < zone.children.length - 3) {
            for (let j = 0; j < starapoz; j++) {
                stary.insertBefore(task, stary.children[starapoz]);
                zlicz(stary);
                zlicz(zone);
            }
        } else {

            var json;
            if (pos) {
                json = JSON.stringify({
                    id: parseInt(task.dataset.noteid), // Assuming 'todo-lane' is the ID of the column
                    column: parseInt(zone.dataset.colid),
                    position: pos
                })
            } else {
                json = JSON.stringify({
                    id: parseInt(task.dataset.noteid), // Assuming 'todo-lane' is the ID of the column
                    column: parseInt(zone.dataset.colid)
                })
            }

            const csrftoken = getCookie('csrftoken');
            const response = await fetch("/api/notes/", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRFToken': csrftoken
                },
                body: json
            });
        }
    }

    draggables.forEach((task) => {
        task.addEventListener("dragstart", () => {
            dragstart(task);
        });
        task.addEventListener("dragend", async () => {
            dragend(task);
        });
    });

    function droppableFunc(zone){
        zone.addEventListener("dragover", async (e) => {
            e.preventDefault();

            const bottomTask = insertAboveTask(zone, e.clientY);
            const curTask = document.querySelector(".is-dragging");

            if (!bottomTask) {
                const form = document.getElementById(zone.id.slice(0, -5) + "-form");
                zone.insertBefore(curTask, form);
            } else {
                zone.insertBefore(curTask, bottomTask);
            }
        });
    }

    droppables.forEach((zone) => {
        droppableFunc(zone);
    });

    const insertAboveTask = (zone, mouseY) => {
        const els = zone.querySelectorAll(".task:not(.is-dragging)");

        let closestTask = null;
        let closestOffset = Number.NEGATIVE_INFINITY;

        els.forEach((task) => {
            const {top} = task.getBoundingClientRect();

            const offset = mouseY - top;

            if (offset < 0 && offset > closestOffset) {
                closestOffset = offset;
                closestTask = task;
            }
        });

        return closestTask;
    };

    const columns = document.getElementById("lanes").children;
    for (let columnsKey in columns) {
        if (!isNaN(parseInt(columnsKey))) {
            if (columns[columnsKey].classList.contains("swim-lane")) {
                document.getElementById(columns[columnsKey].id.slice(0, -5) + "-form").addEventListener("submit", handleSubmit);
            }
        }
    }

    function zlicz(element) {
        const licznik = element.getElementsByClassName("heading")[0].getElementsByClassName("licznik")[0];
        if(licznik.dataset.max == "None" || licznik.dataset.max == "null"){
            licznik.innerText = licznik.parentElement.parentElement.children.length-3;
        }
        else{
            licznik.innerText = licznik.parentElement.parentElement.children.length-3+"/"+licznik.dataset.max;
        }
    }

    document.querySelectorAll(".licznik").forEach((element) => {
        if(element.dataset.max == "None"){
            element.innerText = element.parentElement.parentElement.children.length-3;
        }
        else{
            element.innerText = element.parentElement.parentElement.children.length-3+"/"+element.dataset.max;
        }
    })

    function acceptNoteChanges(task, taskValue) {
        const json = JSON.stringify({id: task.dataset.noteid, name: taskValue});
        task.textContent = "updating...";
        const csrftoken = getCookie('csrftoken');
        fetch('/api/notes/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: json
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            task.textContent = data.name;
            giveDefaultButtons(task);
        })
        .catch(error => console.error(error));
    }

    function giveDefaultButtons(note){
        console.log(note)
        const usuwanie = document.createElement("button");
        usuwanie.classList.add("usuwanie");
        usuwanie.onclick = function (){usunTaska(note.id+'-note')};
        usuwanie.textContent = "ðŸ—‘";
        const edytowanie = document.createElement("button");
        edytowanie.classList.add("edytowanie");
        edytowanie.onclick = function (){usunTaska(note.id+'-note')};
        edytowanie.textContent = "E";
        note.appendChild(usuwanie);
        note.appendChild(edytowanie);
    }

    function cancelNoteChanges(note){//nie dziala
        var noteDiv = document.getElementById("note-"+note.id);
        noteDiv.textContent = note.name;
        giveDefaultButtons(note);
    }

    function edytujTaska(nazwa) { //nie dziala(prawie dziala)
        const task = document.getElementById(nazwa);
        const textbox = document.createElement("input");
        textbox.type = "text";
        var text = '';
            for (var i = 0; i < task.childNodes.length; ++i)
                if (task.childNodes[i].nodeType === Node.TEXT_NODE)
                    text += task.childNodes[i].textContent;
        textbox.value = text.trim(); // UÅ¼yj value zamiast textContent
        task.textContent = task.name;
        task.appendChild(textbox);
        const button = document.createElement("button");
        button.type = "submit";
        button.name = "edit";
        button.classList.add('edit');
        button.innerText = "âœ…";
        button.onclick = function () {
            // Przekazuj wartoÅ›Ä‡ textbox.value do funkcji acceptNoteChanges
            acceptNoteChanges(task, textbox.value);
        };
        task.appendChild(button);
    }

    function usunTaska(nazwa) {
        const task = document.getElementById(nazwa);
        const id = task.dataset.noteid;
        const csrftoken = getCookie('csrftoken');
        fetch("/api/notes/", {
            method: "Delete",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': csrftoken
            },
                body: JSON.stringify({id: id})
        });
        task.remove();
    }

    function wyswietlKolumne(kol) {

        const lista = document.getElementById('lanes');
        const dodaj = document.getElementById('add');
        const kolumna = document.createElement('div');
        kolumna.classList.add("swim-lane");
        kolumna.id = kol.id+"-lane";
        kolumna.dataset.colid = kol.id;
        const nazwa = document.createElement('div');
        nazwa.classList.add("heading");
        const tekst = document.createElement("div");
        tekst.classList.add("nazwa");
        const h4 = document.createElement("h4");
        h4.innerText = kol.name;
        tekst.appendChild(h4);
        nazwa.appendChild(tekst);
        const licznik = document.createElement("div");
        licznik.classList.add("licznik");
        licznik.dataset.max = kol.max;
        nazwa.appendChild(licznik);
        const przyciskiDiv = document.createElement('div');
        przyciskiDiv.classList.add('przyciski');
        const edytuj = document.createElement('button');
        edytuj.type = "submit";
        edytuj.name = "edit";
        edytuj.classList.add('edit');
        edytuj.innerText = "Edytuj";
        const usun = document.createElement('button');
        usun.type = "submit";
        usun.name = "delete";
        usun.classList.add('delete');
        usun.innerText = "UsuÅ„";
        usun.onclick = function() {usunKolumne(kol.id)};
        const form = document.createElement('form');
        form.id = kol.id+'-form';
        form.classList.add('note-form');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Nowe zadanie...';
        input.id = kol.id+'-input';
        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.innerText = "Dodaj";
        //<button class="usuwanie">ðŸ—‘</button>
        form.appendChild(input);
        form.appendChild(submit);
        form.addEventListener("submit", handleSubmit);
        przyciskiDiv.appendChild(edytuj);
        przyciskiDiv.appendChild(usun);
        kolumna.appendChild(nazwa);
        kolumna.appendChild(przyciskiDiv);
        kolumna.appendChild(form);
        lista.insertBefore(kolumna,dodaj);
        droppableFunc(kolumna);
        zlicz(kolumna);
    }

    async function dodajKolumne() {
        const csrftoken = getCookie('csrftoken');
        const response = await fetch("/api/columns/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': csrftoken
            }
        })
            .then(response => response.json())
            .then(data => {
                wyswietlKolumne(data);
            });
    }

    function acceptColumnChanges(column, columnValue, maxValue) {
        const json = JSON.stringify({id: column.dataset.colid, name: columnValue, max: maxValue});
        column.textContent = "updating...";
        const csrftoken = getCookie('csrftoken');
        fetch('/api/columns/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: json
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            column.textContent = data.name;
            giveDefaultButtons(column);
        })
        .catch(error => console.error(error));
    }

    function giveColumnButtons(column){
        const usuwanie = document.createElement("button");
        usuwanie.classList.add("delete");
        usuwanie.onclick = function (){usunKolumne(column.id+'-lane')};
        usuwanie.textContent = "delete";
        const edytowanie = document.createElement("button");
        edytowanie.classList.add("edit");
        edytowanie.onclick = function (){edytujKolumne(column.id+'-lane')};
        edytowanie.textContent = "Edit";
        column.appendChild(usuwanie);
        column.appendChild(edytowanie);

    }

    function cancelColumnChanges(column){//nie dziala
        var columnDiv = document.getElementById(column.id+"-lane");
        columnDiv.textContent = column.name;
        giveColumnButtons(column);
    }

    function edytujKolumne(nazwa) {
        const columnLane = document.getElementById(nazwa + "-lane");
        let maxElement = columnLane.querySelector(".licznik");
        const nameElement = columnLane.querySelector(".nazwa h4");

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = nameElement.textContent.trim();
        nameElement.textContent = '';
        nameElement.appendChild(nameInput);

        const maxInput = document.createElement("input");
        maxInput.type = "text";
        maxInput.value = maxElement.dataset.max ? maxElement.dataset.max : '';
        maxElement.textContent = '';
        maxElement.appendChild(maxInput);

        const submitButton = document.createElement("button");
        submitButton.type = "submit";
        submitButton.name = "edit";
        submitButton.classList.add("edit");
        submitButton.innerText = "âœ…";
        submitButton.onclick = function () {
            acceptColumnChanges(columnLane, nameInput.value, maxInput.value);
        };

        columnLane.appendChild(submitButton);
    }

    function usunKolumne(id) {
        const kolumna = document.getElementById(id+'-lane');
        const csrftoken = getCookie('csrftoken');
        fetch("/api/columns/", {
            method: "Delete",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': csrftoken
            },
                body: JSON.stringify({id: id})
        }).then((response)=>{
            if(response.status == 204){
                kolumna.remove();
            }
        });
    }


</script>
</body>
</html>